<?xml version="1.0" encoding="UTF-8"?>
<!--
 ~ Hibernate Search, full-text search for your domain model
 ~
 ~ License: GNU Lesser General Public License (LGPL), version 2.1 or later
 ~ See the lgpl.txt file in the root directory or <http://www.gnu.org/licenses/lgpl-2.1.html>.
  -->
<job id="hibernate-search-mass-indexing" xmlns="http://xmlns.jcp.org/xml/ns/javaee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd" version="1.0">

    <listeners>
        <listener ref="org.hibernate.search.jsr352.massindexing.JobParameterValidationListener">
            <properties>
                <property name="checkpointInterval" value="#{jobParameters['checkpointInterval']}?:200;" />
                <property name="rowsPerPartition" value="#{jobParameters['rowsPerPartition']}?:250;" />
            </properties>
        </listener>
        <listener ref="org.hibernate.search.jsr352.massindexing.impl.JobContextSetupListener">
            <properties>
                <property name="entityManagerFactoryScope" value="#{jobParameters['entityManagerFactoryScope']}" />
                <property name="entityManagerFactoryReference" value="#{jobParameters['entityManagerFactoryReference']}" />
                <property name="entityTypes" value="#{jobParameters['entityTypes']}" />
                <property name="customQueryCriteria" value="#{jobParameters['customQueryCriteria']}" />
            </properties>
        </listener>
    </listeners>

    <step id="beforeChunk" next="produceLuceneDoc">
        <batchlet ref="org.hibernate.search.jsr352.massindexing.impl.steps.beforechunk.BeforeChunkBatchlet">
            <properties>
                <property name="optimizeAfterPurge" value="#{jobParameters['optimizeAfterPurge']}?:false;" />
                <property name="purgeAllOnStart" value="#{jobParameters['purgeAllOnStart']}?:false;" />
                <property name="tenantId" value="#{jobParameters['tenantId']}" />
            </properties>
        </batchlet>
    </step>

    <step id="produceLuceneDoc" next="afterChunk">
        <listeners>
            <listener ref="org.hibernate.search.jsr352.massindexing.impl.steps.lucene.StepProgressSetupListener">
                <properties>
                    <property name="tenantId" value="#{jobParameters['tenantId']}" />
                </properties>
            </listener>
        </listeners>
        <chunk checkpoint-policy="custom">
            <reader ref="org.hibernate.search.jsr352.massindexing.impl.steps.lucene.EntityReader">
                <properties>
                	<!-- Used to re-create the job context data as necessary -->
	                <property name="entityManagerFactoryScope" value="#{jobParameters['entityManagerFactoryScope']}" />
	                <property name="entityManagerFactoryReference" value="#{jobParameters['entityManagerFactoryReference']}" />
	                <property name="entityTypes" value="#{jobParameters['entityTypes']}" />
	                <property name="customQueryCriteria" value="#{jobParameters['customQueryCriteria']}" />

                    <property name="entityName" value="#{partitionPlan['entityName']}" />
                    <property name="partitionId" value="#{partitionPlan['partitionId']}" />
                    <property name="tenantId" value="#{jobParameters['tenantId']}" />
                    <property name="cacheable" value="#{jobParameters['cacheable']}?:false;" />
                    <property name="fetchSize" value="#{jobParameters['fetchSize']}?:200000;" />
                    <property name="customQueryHQL" value="#{jobParameters['customQueryHQL']}" />
                    <property name="customQueryLimit" value="#{jobParameters['customQueryLimit']}?:10000000;" />
                </properties>
            </reader>
            <processor ref="org.hibernate.search.jsr352.massindexing.impl.steps.lucene.LuceneDocProducer">
                <properties>
                    <property name="entityName" value="#{partitionPlan['entityName']}" />
                    <property name="tenantId" value="#{jobParameters['tenantId']}" />
                </properties>
            </processor>
            <writer ref="org.hibernate.search.jsr352.massindexing.impl.steps.lucene.LuceneDocWriter">
                <properties>
                    <property name="entityName" value="#{partitionPlan['entityName']}" />
                    <property name="partitionId" value="#{partitionPlan['partitionId']}" />
                </properties>
            </writer>
            <checkpoint-algorithm ref="org.hibernate.search.jsr352.massindexing.impl.steps.lucene.CheckpointAlgorithm">
                <properties>
                    <property name="checkpointInterval" value="#{jobParameters['checkpointInterval']}?:200;" />
                </properties>
            </checkpoint-algorithm>
        </chunk>
        <partition>
            <mapper ref="org.hibernate.search.jsr352.massindexing.impl.steps.lucene.PartitionMapper">
                <properties>
                    <property name="tenantId" value="#{jobParameters['tenantId']}" />
                    <property name="fetchSize" value="#{jobParameters['fetchSize']}?:200000;" />
                    <property name="customQueryHQL" value="#{jobParameters['customQueryHQL']}" />
                    <property name="maxThreads" value="#{jobParameters['maxThreads']}?:8;" />
                    <property name="rowsPerPartition" value="#{jobParameters['rowsPerPartition']}?:250;" />
                </properties>
            </mapper>
            <collector ref="org.hibernate.search.jsr352.massindexing.impl.steps.lucene.ProgressCollector" />
            <analyzer ref="org.hibernate.search.jsr352.massindexing.impl.steps.lucene.ProgressAggregator" />
        </partition>
    </step>

    <step id="afterChunk">
        <batchlet ref="org.hibernate.search.jsr352.massindexing.impl.steps.afterchunk.AfterChunkBatchlet">
            <properties>
                <property name="optimizeOnFinish" value="#{jobParameters['optimizeOnFinish']}?:false;" />
                <property name="tenantId" value="#{jobParameters['tenantId']}" />
            </properties>
        </batchlet>
    </step>

</job>
