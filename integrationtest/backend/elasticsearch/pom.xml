<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.hibernate.search</groupId>
        <artifactId>hibernate-search-integrationtest</artifactId>
        <version>8.2.3-SNAPSHOT</version>
        <relativePath>../..</relativePath>
    </parent>
    <artifactId>hibernate-search-integrationtest-backend-elasticsearch</artifactId>

    <name>Hibernate Search ITs - Backend - Elasticsearch</name>
    <description>Hibernate Search integration tests for the Elasticsearch backend, running the Backend TCK in particular</description>

    <properties>
        <surefire.module>elasticsearch</surefire.module>

        <failsafe.client.elasticsearch.reportsDirectory>${project.build.directory}/failsafe-reports/elasticsearch-rest</failsafe.client.elasticsearch.reportsDirectory>
        <failsafe.client.elasticsearch.summaryFile>${failsafe.client.elasticsearch.reportsDirectory}/failsafe-summary.xml</failsafe.client.elasticsearch.summaryFile>
        <failsafe.jvm.args.jacoco.client.elasticsearch></failsafe.jvm.args.jacoco.client.elasticsearch>

        <failsafe.client.opensearch.reportsDirectory>${project.build.directory}/failsafe-reports/opensearch-rest</failsafe.client.opensearch.reportsDirectory>
        <failsafe.client.opensearch.summaryFile>${failsafe.client.opensearch.reportsDirectory}/failsafe-summary.xml</failsafe.client.opensearch.summaryFile>
        <failsafe.jvm.args.jacoco.client.opensearch></failsafe.jvm.args.jacoco.client.opensearch>

        <failsafe.client.elasticsearch.rest5.reportsDirectory>${project.build.directory}/failsafe-reports/elasticsearch-rest5</failsafe.client.elasticsearch.rest5.reportsDirectory>
        <failsafe.client.elasticsearch.rest5.summaryFile>${failsafe.client.elasticsearch.rest5.reportsDirectory}/failsafe-summary.xml</failsafe.client.elasticsearch.rest5.summaryFile>
        <failsafe.jvm.args.jacoco.client.elasticsearch.rest5></failsafe.jvm.args.jacoco.client.elasticsearch.rest5>

        <failsafe.client.jdk.reportsDirectory>${project.build.directory}/failsafe-reports/elasticsearch-jdk</failsafe.client.jdk.reportsDirectory>
        <failsafe.client.jdk.summaryFile>${failsafe.client.jdk.reportsDirectory}/failsafe-summary.xml</failsafe.client.jdk.summaryFile>
        <failsafe.jvm.args.jacoco.client.jdk></failsafe.jvm.args.jacoco.client.jdk>

        <surefire.jvm.args.module>
            ${test.mockito.agent.jvm.args}
        </surefire.jvm.args.module>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.hibernate.search</groupId>
            <artifactId>hibernate-search-backend-elasticsearch</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.hibernate.search</groupId>
            <artifactId>hibernate-search-backend-elasticsearch-client-opensearch-rest</artifactId>
        </dependency>
        <dependency>
            <groupId>org.hibernate.search</groupId>
            <artifactId>hibernate-search-backend-elasticsearch-client-rest5</artifactId>
        </dependency>
        <dependency>
            <groupId>org.hibernate.search</groupId>
            <artifactId>hibernate-search-backend-elasticsearch-client-rest4</artifactId>
        </dependency>

        <dependency>
            <groupId>org.hibernate.search</groupId>
            <artifactId>hibernate-search-integrationtest-backend-tck</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.hibernate.search</groupId>
            <artifactId>hibernate-search-util-internal-integrationtest-common</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.hibernate.search</groupId>
            <artifactId>hibernate-search-util-internal-integrationtest-backend-elasticsearch</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.wiremock</groupId>
            <artifactId>wiremock</artifactId>
            <scope>test</scope>
            <exclusions>
                <!-- Exclude dependencies that conflict with the ES Rest client -->
                <exclusion>
                    <groupId>org.apache.httpcomponents</groupId>
                    <artifactId>httpclient</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-failsafe-plugin</artifactId>
                <executions>
                    <execution>
                        <id>it</id>
                        <goals>
                            <goal>integration-test</goal>
                            <goal>verify</goal>
                        </goals>
                        <configuration>
                            <skip>${test.elasticsearch.skip}</skip>
                            <reportNameSuffix>${surefire.executionIdentifier}-elasticsearch-rest</reportNameSuffix>
                            <reportsDirectory>${failsafe.client.elasticsearch.reportsDirectory}</reportsDirectory>
                            <summaryFile>${failsafe.client.elasticsearch.summaryFile}</summaryFile>
                            <argLine>${failsafe.jvm.args.no-jacoco} @{failsafe.jvm.args.jacoco.client.elasticsearch}</argLine>
                            <!-- WARNING: When using <dependenciesToScan>, be sure to set the Maven property surefire.module -->
                            <dependenciesToScan>
                                <dependency>${project.groupId}:hibernate-search-integrationtest-backend-tck</dependency>
                            </dependenciesToScan>
                            <systemProperties>
                                <org.hibernate.search.integrationtest.backend.elasticsearch.client.type>elasticsearch-rest4</org.hibernate.search.integrationtest.backend.elasticsearch.client.type>
                            </systemProperties>
                            <classpathDependencyExcludes>
                                <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-opensearch-rest</exclude>
                                <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-rest5</exclude>
                            </classpathDependencyExcludes>
                            <excludes>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientRest5ElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientOpenSearchElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientRest5ElasticsearchExtensionIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientOpenSearchElasticsearchExtensionIT</exclude>
                            </excludes>
                        </configuration>
                    </execution>
                    <execution>
                        <id>it-opensearch-client</id>
                        <goals>
                            <goal>integration-test</goal>
                            <goal>verify</goal>
                        </goals>
                        <configuration>
                            <skip>${test.elasticsearch.skip}</skip>
                            <reportNameSuffix>${surefire.executionIdentifier}-opensearch-rest</reportNameSuffix>
                            <reportsDirectory>${failsafe.client.opensearch.reportsDirectory}</reportsDirectory>
                            <summaryFile>${failsafe.client.opensearch.summaryFile}</summaryFile>
                            <argLine>${failsafe.jvm.args.no-jacoco} @{failsafe.jvm.args.jacoco.client.opensearch}</argLine>
                            <systemProperties>
                                <org.hibernate.search.integrationtest.backend.elasticsearch.client.type>opensearch-rest</org.hibernate.search.integrationtest.backend.elasticsearch.client.type>
                            </systemProperties>
                            <classpathDependencyExcludes>
                                <!-- Do not remove the "default" client so that we can test this scenario where a user drops a dependency to a nondefault one -->
                                <!-- <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-rest<4/exclude> -->
                                <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-rest5</exclude>
                            </classpathDependencyExcludes>
                            <excludes>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientRest5ElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientRest4ElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientRest4ElasticsearchExtensionIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientRest5ElasticsearchExtensionIT</exclude>
                            </excludes>
                        </configuration>
                    </execution>
                    <execution>
                        <id>it-elasticsearch-rest5-client</id>
                        <goals>
                            <goal>integration-test</goal>
                            <goal>verify</goal>
                        </goals>
                        <configuration>
                            <skip>${test.elasticsearch.skip}</skip>
                            <reportNameSuffix>${surefire.executionIdentifier}-elasticsearch-rest5</reportNameSuffix>
                            <reportsDirectory>${failsafe.client.elasticsearch.rest5.reportsDirectory}</reportsDirectory>
                            <summaryFile>${failsafe.client.elasticsearch.rest5.summaryFile}</summaryFile>
                            <argLine>${failsafe.jvm.args.no-jacoco} @{failsafe.jvm.args.jacoco.client.elasticsearch.rest5}</argLine>
                            <systemProperties>
                                <org.hibernate.search.integrationtest.backend.elasticsearch.client.type>elasticsearch-rest5</org.hibernate.search.integrationtest.backend.elasticsearch.client.type>
                            </systemProperties>
                            <classpathDependencyExcludes>
                                <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-rest4</exclude>
                                <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-opensearch-rest</exclude>
                            </classpathDependencyExcludes>
                            <excludes>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientRest4ElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientOpenSearchElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientRest4ElasticsearchExtensionIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientOpenSearchElasticsearchExtensionIT</exclude>
                            </excludes>
                        </configuration>
                    </execution>
                    <execution>
                        <id>it-jdk-client</id>
                        <goals>
                            <goal>integration-test</goal>
                            <goal>verify</goal>
                        </goals>
                        <configuration>
                            <trimStackTrace>false</trimStackTrace>
                            <skip>${test.elasticsearch.skip}</skip>
                            <reportNameSuffix>${surefire.executionIdentifier}-jdk</reportNameSuffix>
                            <reportsDirectory>${failsafe.client.jdk.reportsDirectory}</reportsDirectory>
                            <summaryFile>${failsafe.client.jdk.summaryFile}</summaryFile>
                            <argLine>${failsafe.jvm.args.no-jacoco} @{failsafe.jvm.args.jacoco.client.jdk}</argLine>
                            <systemProperties>
                                <org.hibernate.search.integrationtest.backend.elasticsearch.client.type>jdk-rest</org.hibernate.search.integrationtest.backend.elasticsearch.client.type>
                            </systemProperties>
                            <classpathDependencyExcludes>
                                <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-rest4</exclude>
                                <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-rest5</exclude>
                                <exclude>org.hibernate.search:hibernate-search-backend-elasticsearch-client-opensearch-rest</exclude>
                            </classpathDependencyExcludes>
                            <excludes>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientRest4ElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientRest5ElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.client.ClientOpenSearchElasticsearchClientFactoryIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientRest4ElasticsearchExtensionIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientRest5ElasticsearchExtensionIT</exclude>
                                <exclude>org.hibernate.search.integrationtest.backend.elasticsearch.ClientOpenSearchElasticsearchExtensionIT</exclude>
                            </excludes>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

    <profiles>
        <profile>
            <id>aws</id>
            <activation>
                <property>
                    <name>test.elasticsearch.connection.aws.signing.enabled</name>
                    <value>true</value>
                </property>
            </activation>
            <dependencies>
                <dependency>
                    <groupId>org.hibernate.search</groupId>
                    <artifactId>hibernate-search-backend-elasticsearch-aws</artifactId>
                    <scope>test</scope>
                </dependency>
            </dependencies>
        </profile>
        <profile>
            <id>coverage</id>
            <build>
                <plugins>
                    <!-- We need to send the jacoco report of each test execution to a different file,
                         otherwise Develocity won't be able to cache test executions. -->
                    <plugin>
                        <groupId>org.jacoco</groupId>
                        <artifactId>jacoco-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>jacoco-prepare-agent-integration</id>
                                <configuration>
                                    <skip>true</skip>
                                </configuration>
                            </execution>
                            <execution>
                                <id>jacoco-prepare-agent-integration-elasticsearch</id>
                                <phase>initialize</phase>
                                <goals>
                                    <goal>prepare-agent-integration</goal>
                                </goals>
                                <configuration>
                                    <propertyName>failsafe.jvm.args.jacoco.client.elasticsearch</propertyName>
                                    <destFile>${project.build.directory}/${jacoco.environment.sub-directory}/elasticsearch/jacoco.exec</destFile>
                                </configuration>
                            </execution>
                            <execution>
                                <id>jacoco-prepare-agent-integration-elasticsearch-rest5</id>
                                <phase>initialize</phase>
                                <goals>
                                    <goal>prepare-agent-integration</goal>
                                </goals>
                                <configuration>
                                    <propertyName>failsafe.jvm.args.jacoco.client.elasticsearch.rest5</propertyName>
                                    <destFile>${project.build.directory}/${jacoco.environment.sub-directory}/elasticsearch-rest5/jacoco.exec</destFile>
                                </configuration>
                            </execution>
                            <execution>
                                <id>jacoco-prepare-agent-integration-opensearch</id>
                                <phase>initialize</phase>
                                <goals>
                                    <goal>prepare-agent-integration</goal>
                                </goals>
                                <configuration>
                                    <propertyName>failsafe.jvm.args.jacoco.client.opensearch</propertyName>
                                    <destFile>${project.build.directory}/${jacoco.environment.sub-directory}/opensearch/jacoco.exec</destFile>
                                </configuration>
                            </execution>
                            <execution>
                                <id>jacoco-prepare-agent-integration-jdk</id>
                                <phase>initialize</phase>
                                <goals>
                                    <goal>prepare-agent-integration</goal>
                                </goals>
                                <configuration>
                                    <propertyName>failsafe.jvm.args.jacoco.client.jdk</propertyName>
                                    <destFile>${project.build.directory}/${jacoco.environment.sub-directory}/jdk/jacoco.exec</destFile>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>

</project>

